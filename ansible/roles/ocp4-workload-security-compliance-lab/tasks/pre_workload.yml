---
# Implement your Pre Workload deployment tasks here

- set_fact:
    tmp_dir: "/tmp/{{ guid }}"
    user_count_end: "{{ (user_count_start | int) + (num_users | int) - 1 }}"

- debug: msg="Using {{tmp_dir}} as temp dir on bastion"
- debug: msg="Installing infrastructure for workshop in {{ admin_project }}"
- debug: msg="Provisioning users from {{user_count_start}} to {{user_count_end}} with format {{user_format}}"

- name: set gogs facts
  set_fact:
    gogs_generate_user_count: "{{ user_count_end }}"

- name: make the temp dir
  file:
    path: "{{tmp_dir}}"
    state: directory

- name: copy the files used
  copy:
    src: "files"
    dest: "{{tmp_dir}}"

- name: make deploy script
  file:
    path: "{{tmp_dir}}/files/deploy.sh"
    mode: "555"

- name: copy the templates
  template:
    src: "{{ item }}"
    dest: "{{tmp_dir}}/{{ item | basename | regex_replace('.j2','') }}"
  with_fileglob: "../templates/*"

# Leave this as the last task in the playbook.
- name: pre_workload tasks complete
  debug:
    msg: "Pre-Workload tasks completed successfully."
  when: not silent|bool
